#!/bin/bash

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è —Å –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–π —Ä–æ—Ç–∞—Ü–∏–µ–π Python
LOG_DIR="/root/myAI/MarketBot/logs"
MAIN_DIR="/root/myAI/MarketBot"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–ø—É—â–µ–Ω –ª–∏ —É–∂–µ –±–æ—Ç
if pgrep -f "python.*src.main.py" > /dev/null; then
    echo "‚ö†Ô∏è –ë–æ—Ç —É–∂–µ –∑–∞–ø—É—â–µ–Ω! –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã..."
    pkill -f "python.*src/main.py"
    sleep 2

    # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
    if pgrep -f "python.*src/main.py" > /dev/null; then
        echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã. –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ..."
        pkill -9 -f "python.*src/main.py"
        sleep 1
    fi
fi

# –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –ª–æ–≥–∏, –µ—Å–ª–∏ –µ—Å—Ç—å
rm -f "$MAIN_DIR/bot.log"

# –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –ª–æ–≥–æ–≤
mkdir -p "$LOG_DIR"

# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
cd "$MAIN_DIR"

# –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞ (Python —Å–∞–º —É–ø—Ä–∞–≤–ª—è–µ—Ç —Ä–æ—Ç–∞—Ü–∏–µ–π –ª–æ–≥–æ–≤)
echo "üöÄ –ó–∞–ø—É—Å–∫–∞—é –±–æ—Ç–∞..."
nohup python3 -m src.main > /dev/null 2>&1 &
BOT_PID=$!

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –±–æ—Ç –∑–∞–ø—É—Å—Ç–∏–ª—Å—è
sleep 2
if ps -p $BOT_PID > /dev/null; then
    echo "‚úÖ –ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω —Å PID: $BOT_PID"
    echo "üìù –õ–æ–≥–∏ –ø–∏—à—É—Ç—Å—è –≤: $LOG_DIR/bot.log (—Ä–æ—Ç–∞—Ü–∏—è: –º–∞–∫—Å. 5–ú–ë –Ω–∞ —Ñ–∞–π–ª, 5 —Ñ–∞–π–ª–æ–≤)"
else
    echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞"
fi